class ChatRoomSocket{constructor(s){this.chatroom=s,this.ws=new WebSocket("wss://app7562.acapp.acwing.com.cn/wss/chatroom/"),this.username=this.chatroom.root.settings.username,this.photo=this.chatroom.root.settings.photo,this.online_users={},this.start()}start(){this.add_listening_events()}add_listening_events(){let s=this;this.ws.onopen=function(){s.send_join()},this.ws.onmessage=function(e){let t=JSON.parse(e.data);s.receive(t)},this.ws.onclose=function(){},this.ws.onerror=function(s){console.error("聊天室连接错误:",s)}}receive(s){switch(s.event){case"join":this.receive_join(s);break;case"leave":this.receive_leave(s);break;case"message":this.receive_message(s);break;case"users_list":this.receive_users_list(s)}}send_join(){this.ws.send(JSON.stringify({event:"join",username:this.username,photo:this.photo}))}send_message(s){this.ws.send(JSON.stringify({event:"message",username:this.username,message:s}))}send_leave(){this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({event:"leave",username:this.username}))}receive_join(s){this.chatroom.add_message("系统",`${s.username} 加入了聊天室`,!0)}receive_leave(s){this.chatroom.add_message("系统",`${s.username} 离开了聊天室`,!0)}receive_message(s){this.chatroom.add_message(s.username,s.message)}receive_users_list(s){this.online_users={},s.users&&Array.isArray(s.users)&&s.users.forEach(s=>{this.online_users[s.username]=s}),this.chatroom.update_users_list(s.users)}close(){this.send_leave(),this.ws.close()}}class AcGameChatRoom{constructor(s){this.root=s,this.$chatroom=$('\n            <div class="ac-game-chatroom">\n                <div class="ac-game-chatroom-container">\n                    <div class="ac-game-chatroom-header">\n                        <h2>BallBlitz聊天室</h2>\n                        <button class="ac-game-chatroom-close">×</button>\n                    </div>\n                    <div class="ac-game-chatroom-messages">\n                        \x3c!-- 消息将显示在这里 --\x3e\n                    </div>\n                    <div class="ac-game-chatroom-input-area">\n                        <input type="text" class="ac-game-chatroom-input" placeholder="输入消息...">\n                        <button class="ac-game-chatroom-send">发送</button>\n                    </div>\n                    <div class="ac-game-chatroom-online-users">\n                        <div class="ac-game-chatroom-admin-button">\n                            <div class="ac-game-chatroom-admin-icon">✉</div>\n                            <span class="ac-game-chatroom-admin-text">私信管理员</span>\n                            <span class="ac-game-chatroom-admin-badge" style="display: none;">0</span>\n                        </div>\n                        <h3>在线用户</h3>\n                        <div class="ac-game-chatroom-users-list">\n                            \x3c!-- 在线用户列表 --\x3e\n                        </div>\n                    </div>\n                </div>\n            </div>\n        '),this.$admin_message=$('\n            <div class="ac-game-admin-message">\n                <div class="ac-game-admin-message-header">\n                    <h3 class="ac-game-admin-message-title">私信管理员</h3>\n                    <button class="ac-game-admin-message-close">×</button>\n                </div>\n                <div class="ac-game-admin-message-content">\n                    <div class="ac-game-admin-message-loading">加载中...</div>\n                </div>\n                <div class="ac-game-admin-message-input-area">\n                    <input type="text" class="ac-game-admin-message-input" placeholder="输入消息...">\n                    <button class="ac-game-admin-message-send">发送</button>\n                </div>\n            </div>\n        '),this.$chatroom.hide(),this.$admin_message.hide(),this.root.$ac_game.append(this.$chatroom),this.root.$ac_game.append(this.$admin_message),this.$messages=this.$chatroom.find(".ac-game-chatroom-messages"),this.$input=this.$chatroom.find(".ac-game-chatroom-input"),this.$send_btn=this.$chatroom.find(".ac-game-chatroom-send"),this.$close_btn=this.$chatroom.find(".ac-game-chatroom-close"),this.$users_list=this.$chatroom.find(".ac-game-chatroom-users-list"),this.$admin_button=this.$chatroom.find(".ac-game-chatroom-admin-button"),this.$admin_badge=this.$chatroom.find(".ac-game-chatroom-admin-badge"),this.$admin_message_content=this.$admin_message.find(".ac-game-admin-message-content"),this.$admin_message_input=this.$admin_message.find(".ac-game-admin-message-input"),this.$admin_message_send=this.$admin_message.find(".ac-game-admin-message-send"),this.$admin_message_close=this.$admin_message.find(".ac-game-admin-message-close"),this.socket=null,this.admin_messages=[],this.start()}formatLocalTime(s){return s}start(){this.add_listening_events(),setInterval(()=>{this.$chatroom.is(":visible")&&this.check_unread_messages()},3e4)}add_listening_events(){let s=this;this.$close_btn.click(function(){s.hide(),s.root.menu.show()}),this.$send_btn.click(function(){s.send_message()}),this.$input.keydown(function(e){if(13===e.which)return s.send_message(),!1}),this.$admin_button.click(function(){s.show_admin_message()}),this.$admin_message_close.click(function(){s.hide_admin_message()}),this.$admin_message_send.click(function(){s.send_admin_message()}),this.$admin_message_input.keydown(function(e){if(13===e.which)return s.send_admin_message(),!1}),$(window).keydown(function(e){27===e.which&&(s.$admin_message.is(":visible")?s.hide_admin_message():s.$chatroom.is(":visible")&&(s.hide(),s.root.menu.show()))})}show_admin_message(){this.$admin_message.css("display","flex"),this.load_admin_messages(),this.$admin_message_input.focus(),this.$admin_badge.hide()}hide_admin_message(){this.$admin_message.hide()}load_admin_messages(){let s=this;this.$admin_message_content.html('<div class="ac-game-admin-message-loading">加载中...</div>'),$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/get_admin_messages/",type:"GET",success:function(e){"success"===e.result?s.render_admin_messages(e.messages):s.$admin_message_content.html('<div class="ac-game-admin-message-empty">加载失败</div>')},error:function(){s.$admin_message_content.html('<div class="ac-game-admin-message-empty">网络错误</div>')}})}render_admin_messages(s){if(this.$admin_message_content.empty(),0!==s.length){for(let e of s){let s=$(`\n                <div class="ac-game-admin-message-item ac-game-admin-message-sent">\n                    <div class="ac-game-admin-message-bubble">${this.escapeHtml(e.message)}</div>\n                    <div class="ac-game-admin-message-time">${this.formatLocalTime(e.timestamp)}</div>\n                </div>\n            `);if(this.$admin_message_content.append(s),e.reply){let s=$(`\n                    <div class="ac-game-admin-message-item ac-game-admin-message-received">\n                        <div class="ac-game-admin-message-bubble">${this.escapeHtml(e.reply)}</div>\n                        <div class="ac-game-admin-message-time">${e.reply_timestamp}</div>\n                    </div>\n                `);this.$admin_message_content.append(s)}}this.$admin_message_content.scrollTop(this.$admin_message_content[0].scrollHeight)}else this.$admin_message_content.html('\n                <div class="ac-game-admin-message-empty">\n                    <div class="ac-game-admin-message-empty-icon">💬</div>\n                    <div class="ac-game-admin-message-empty-text">暂无消息</div>\n                </div>\n            ')}send_admin_message(){let s=this,e=this.$admin_message_input.val().trim();e&&(this.$admin_message_send.prop("disabled",!0),$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/send_admin_message/",type:"POST",headers:{"X-CSRFToken":this.get_csrf_token()},data:JSON.stringify({message:e}),contentType:"application/json",success:function(t){if("success"===t.result){s.$admin_message_input.val("");let i=$(`\n                        <div class="ac-game-admin-message-item ac-game-admin-message-sent">\n                            <div class="ac-game-admin-message-bubble">${s.escapeHtml(e)}</div>\n                            <div class="ac-game-admin-message-time">${t.timestamp}</div>\n                        </div>\n                    `);s.$admin_message_content.find(".ac-game-admin-message-empty").length>0&&s.$admin_message_content.empty(),s.$admin_message_content.append(i),s.$admin_message_content.scrollTop(s.$admin_message_content[0].scrollHeight)}else alert(t.message||"发送失败")},error:function(){alert("网络错误，请重试")},complete:function(){s.$admin_message_send.prop("disabled",!1)}}))}get_csrf_token(){let s=null,e="csrftoken";if(document.cookie&&""!==document.cookie){let t=document.cookie.split(";");for(let i=0;i<t.length;i++){let a=t[i].trim();if(a.substring(0,10)===e+"="){s=decodeURIComponent(a.substring(10));break}}}return s}check_unread_messages(){let s=this;$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/get_unread_count/",type:"GET",success:function(e){"success"===e.result&&e.count>0?s.$admin_badge.text(e.count).show():s.$admin_badge.hide()}})}send_message(){let s=this.$input.val().trim();s&&this.socket&&this.socket.ws.readyState===WebSocket.OPEN&&(this.socket.send_message(s),this.$input.val(""),this.$send_btn.prop("disabled",!0),setTimeout(()=>{this.$send_btn.prop("disabled",!1)},100))}escapeHtml(s){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return s.replace(/[&<>"']/g,s=>e[s])}add_message(s,e,t=!1){if(t){let s=$(`\n            <div class="ac-game-chatroom-message system-message">\n                <div class="message-bubble">\n                    ${e}\n                </div>\n            </div>\n        `);this.$messages.append(s)}else{let t=s===this.root.settings.username,i=t?"message-self":"message-other",a=this.root.settings.photo;if(!t&&this.socket&&this.socket.online_users){let e=this.socket.online_users[s];e&&(a=e.photo)}let n=$(`\n            <div class="ac-game-chatroom-message ${i}">\n                <img class="message-avatar" src="${a}" alt="${s}" title="${s}">\n                <div class="message-bubble">\n                    <div class="message-content">${this.escapeHtml(e)}</div>\n                </div>\n            </div>\n        `);this.$messages.append(n)}this.$messages.scrollTop(this.$messages[0].scrollHeight)}update_users_list(s){this.$users_list.empty();for(let e of s){let s=$(`\n                <div class="ac-game-chatroom-user">\n                    <img src="${e.photo}" alt="${e.username}">\n                    <span>${e.username}</span>\n                </div>\n            `);this.$users_list.append(s)}}show(){this.$chatroom.show(),this.$input.focus(),this.socket||(this.socket=new ChatRoomSocket(this)),this.check_unread_messages()}hide(){this.$chatroom.hide(),this.hide_admin_message(),this.socket&&(this.socket.close(),this.socket=null)}}class AcGameLeaderboard{constructor(s){this.root=s,this.current_page=1,this.total_pages=1,this.$leaderboard=$('\n            <div class="ac-game-leaderboard" style="display: none;">\n                <div class="ac-game-leaderboard-container">\n                    <div class="ac-game-leaderboard-header">\n                        <h2 class="ac-game-leaderboard-title">\n                            <span class="ac-game-leaderboard-icon">🏆</span>\n                            排行榜\n                        </h2>\n                        <button class="ac-game-leaderboard-close">×</button>\n                    </div>\n                    <div class="ac-game-leaderboard-content">\n                        <div class="ac-game-leaderboard-table"></div>\n                    </div>\n                    <div class="ac-game-leaderboard-pagination">\n                        <div class="ac-game-leaderboard-page-info"></div>\n                        <div class="ac-game-leaderboard-page-buttons"></div>\n                    </div>\n                </div>\n            </div>\n        '),this.$leaderboard.hide(),this.root.$ac_game.append(this.$leaderboard),this.$table=this.$leaderboard.find(".ac-game-leaderboard-table"),this.$page_info=this.$leaderboard.find(".ac-game-leaderboard-page-info"),this.$page_buttons=this.$leaderboard.find(".ac-game-leaderboard-page-buttons"),this.$close_btn=this.$leaderboard.find(".ac-game-leaderboard-close"),this.start()}start(){this.add_listening_events()}add_listening_events(){let s=this;this.$close_btn.click(function(){s.hide(),s.root.menu.show()}),$(window).keydown(function(e){27===e.which&&s.$leaderboard.is(":visible")&&(s.hide(),s.root.menu.show())})}show(){this.$leaderboard.show(),this.load_ranklist(1)}hide(){this.$leaderboard.hide()}load_ranklist(s){let e=this;this.$table.html('<div class="ac-game-leaderboard-loading">加载中...</div>'),$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/ranklist/",type:"GET",data:{page:s},success:function(s){"success"===s.result?e.render_ranklist(s):e.$table.html('<div class="ac-game-leaderboard-empty">加载失败</div>')},error:function(){e.$table.html('<div class="ac-game-leaderboard-empty">网络错误</div>')}})}render_ranklist(s){let e=this;if(this.$table.empty(),0===s.ranklist.length)return void this.$table.html('\n                <div class="ac-game-leaderboard-empty">\n                    <div class="ac-game-leaderboard-empty-icon">📭</div>\n                    <div>暂无数据</div>\n                </div>\n            ');s.ranklist.forEach(function(s){let t="";1===s.rank?t="rank-1":2===s.rank?t="rank-2":3===s.rank&&(t="rank-3");let i=s.rank;s.rank<=3&&(i=s.rank);let a=$(`\n                <div class="ac-game-leaderboard-row ${t}">\n                    <div class="ac-game-leaderboard-rank">${i}</div>\n                    <div class="ac-game-leaderboard-user">\n                        <img class="ac-game-leaderboard-avatar" \n                             src="${s.photo}" \n                             alt="${s.username}"\n                             onerror="this.src='https://app7562.acapp.acwing.com.cn/static/image/favicon/favicon.png'">\n                        <span class="ac-game-leaderboard-username">${s.username}</span>\n                    </div>\n                    <div class="ac-game-leaderboard-score">${s.score}</div>\n                </div>\n            `);e.$table.append(a)}),this.current_page=s.current_page,this.total_pages=s.total_pages;let t=20*(s.current_page-1)+1,i=Math.min(20*s.current_page,s.total_players);this.$page_info.html(`显示 ${t}-${i} 名，共 ${s.total_players} 名玩家`),this.render_pagination(s)}render_pagination(s){let e=this;this.$page_buttons.empty();let t=$('<button class="ac-game-leaderboard-page-btn">上一页</button>');s.has_previous?t.click(function(){e.load_ranklist(e.current_page-1)}):t.prop("disabled",!0),this.$page_buttons.append(t);let i=Math.max(1,s.current_page-2),a=Math.min(s.total_pages,s.current_page+2);i>1&&(this.add_page_button(1),i>2&&this.$page_buttons.append('<button class="ac-game-leaderboard-page-btn" disabled>...</button>'));for(let s=i;s<=a;s++)this.add_page_button(s);a<s.total_pages&&(a<s.total_pages-1&&this.$page_buttons.append('<button class="ac-game-leaderboard-page-btn" disabled>...</button>'),this.add_page_button(s.total_pages));let n=$('<button class="ac-game-leaderboard-page-btn">下一页</button>');s.has_next?n.click(function(){e.load_ranklist(e.current_page+1)}):n.prop("disabled",!0),this.$page_buttons.append(n)}add_page_button(s){let e=this,t=$(`<button class="ac-game-leaderboard-page-btn">${s}</button>`);s===this.current_page?t.addClass("active"):t.click(function(){e.load_ranklist(s)}),this.$page_buttons.append(t)}}class AcGameMenu{constructor(s){this.root=s,this.$menu=$('\n<div class="ac-game-menu">\n    <div class="ac-game-menu-user-info">\n        <img class="ac-game-menu-user-avatar" src="" alt="用户头像">\n        <span class="ac-game-menu-user-name"></span>\n    </div>\n\n     <div class="ac-game-menu-guide">\n            <div class="ac-game-menu-guide-toggle">\n                <span class="ac-game-menu-guide-text">操作指南</span>\n                <span class="ac-game-menu-guide-arrow">▼</span>\n            </div>\n            <div class="ac-game-menu-guide-content">\n                <h3>游戏操作说明</h3>\n                <div class="ac-game-menu-guide-item">\n                    <strong>移动：</strong>鼠标<span class="ac-game-menu-guide-key">右键</span>控制角色移动\n                </div>\n                <div class="ac-game-menu-guide-item">\n                    <strong>火球：</strong>按下<span class="ac-game-menu-guide-key">Q</span>键选择技能，<span class="ac-game-menu-guide-key">左键</span>发射\n                </div>\n                <div class="ac-game-menu-guide-item">\n                    <strong>闪现：</strong>按下<span class="ac-game-menu-guide-key">F</span>键选择技能，<span class="ac-game-menu-guide-key">左键</span>释放\n                </div>\n                <div class="ac-game-menu-guide-item">\n                    <strong>多人模式聊天窗：</strong>按下<span class="ac-game-menu-guide-key">ENTER</span>键打开聊天窗，<span class="ac-game-menu-guide-key">ESC</span>键关闭\n                </div>\n                <div class="ac-game-menu-guide-item">\n                    <strong>游戏结束后：</strong>点击<span class="ac-game-menu-guide-key">任意位置</span>回到<span class="ac-game-menu-guide-key">菜单</span>\n                </div>\n            </div>\n        </div>\n\n\n    <div class="ac-game-menu-field">\n        <div class="ac-game-menu-field-item ac-game-menu-field-item-single-mode">\n            单人模式\n        </div>\n        <br>\n        <div class="ac-game-menu-field-item ac-game-menu-field-item-multi-mode">\n            多人模式\n        </div>\n        <br>\n        <div class="ac-game-menu-field-item ac-game-menu-field-item-leaderboard">\n            排行榜\n        </div>\n        <br>\n        <div class="ac-game-menu-field-item ac-game-menu-field-item-chatroom">\n            聊天室\n        </div>\n        <br>\n        <div class="ac-game-menu-field-item ac-game-menu-field-item-settings">\n            设置\n        </div>\n        <br>\n        <div class="ac-game-menu-field-item ac-game-menu-field-item-exit">\n            退出登录\n        </div>\n    </div>\n</div>\n'),this.$menu.hide(),this.root.$ac_game.append(this.$menu),this.$user_info=this.$menu.find(".ac-game-menu-user-info"),this.$user_avatar=this.$menu.find(".ac-game-menu-user-avatar"),this.$user_name=this.$menu.find(".ac-game-menu-user-name"),this.$single_mode=this.$menu.find(".ac-game-menu-field-item-single-mode"),this.$multi_mode=this.$menu.find(".ac-game-menu-field-item-multi-mode"),this.$leaderboard=this.$menu.find(".ac-game-menu-field-item-leaderboard"),this.$chatroom=this.$menu.find(".ac-game-menu-field-item-chatroom"),this.$settings=this.$menu.find(".ac-game-menu-field-item-settings"),this.$exit=this.$menu.find(".ac-game-menu-field-item-exit"),this.$guide_toggle=this.$menu.find(".ac-game-menu-guide-toggle"),this.$guide_content=this.$menu.find(".ac-game-menu-guide-content"),this.$guide_arrow=this.$menu.find(".ac-game-menu-guide-arrow"),this.start()}start(){this.add_listening_events(),this.update_user_info()}update_user_info(){this.root.settings&&this.root.settings.username&&this.root.settings.photo&&(this.$user_avatar.attr("src",this.root.settings.photo),this.$user_name.text(this.root.settings.username))}add_listening_events(){let s=this;this.$user_info.click(function(){s.hide(),s.root.user_settings.show()}),this.$single_mode.click(function(){s.hide(),s.root.playground.show("single mode")}),this.$multi_mode.click(function(){s.hide(),s.root.playground.show("multi mode")}),this.$leaderboard.click(function(){s.hide(),s.root.leaderboard.show()}),this.$chatroom.click(function(){s.hide(),s.root.chatroom.show()}),this.$settings.click(function(){s.hide(),s.root.user_settings.show()}),this.$exit.click(function(){s.root.settings.logout_on_remote()}),this.$guide_toggle.click(function(){s.$guide_content.toggleClass("active"),s.$guide_arrow.toggleClass("active")}),$(document).click(function(e){$(e.target).closest(".ac-game-menu-guide").length||s.$guide_content.hasClass("active")&&(s.$guide_content.removeClass("active"),s.$guide_arrow.removeClass("active"))})}show(){this.$menu.show(),this.update_user_info()}hide(){this.$menu.hide()}}let last_timestamp,AC_GAME_OBJECTS=[];class AcGameObject{constructor(){AC_GAME_OBJECTS.push(this),this.has_called_start=!1,this.timedelta=0,this.uuid=this.create_uuid()}create_uuid(){let s="";for(let e=0;e<8;e++){s+=parseInt(Math.floor(10*Math.random()))}return s}start(){}update(){}late_update(){}on_destroy(){}destroy(){this.on_destroy();for(let s=0;s<AC_GAME_OBJECTS.length;s++)if(AC_GAME_OBJECTS[s]===this){AC_GAME_OBJECTS.splice(s,1);break}}}let AC_GAME_ANIMATION=function(s){for(let e=0;e<AC_GAME_OBJECTS.length;e++){let t=AC_GAME_OBJECTS[e];t.has_called_start?(t.timedelta=s-last_timestamp,t.update()):(t.start(),t.has_called_start=!0)}for(let s=0;s<AC_GAME_OBJECTS.length;s++){AC_GAME_OBJECTS[s].late_update()}last_timestamp=s,requestAnimationFrame(AC_GAME_ANIMATION)};requestAnimationFrame(AC_GAME_ANIMATION);class ChatField{constructor(s){this.playground=s,this.$history=$('<div class="ac-game-chat-field-history">历史记录</div>'),this.$input=$('<input type="text" class="ac-game-chat-field-input">'),this.$history.hide(),this.$input.hide(),this.$history.on("contextmenu",function(s){return s.preventDefault(),!1}),this.$input.on("contextmenu",function(s){return s.preventDefault(),!1}),this.func_id=null,this.is_input_active=!1,this.playground.$playground.append(this.$history),this.playground.$playground.append(this.$input),this.start()}start(){this.add_listening_events()}add_listening_events(){let s=this;this.$input.keydown(function(e){if(27===e.which)return s.hide_input(),s.hide_history(),!1;if(13===e.which){let e=s.playground.root.settings.username,t=s.$input.val();return t&&(s.$input.val(""),s.add_message(e,t),s.playground.mps.send_message(e,t)),!1}}),this.playground.$playground.mousedown(function(e){let t=$(e.target);t.is(s.$input)||t.is(s.$history)||t.closest(".ac-game-chat-field-history").length||(s.$input.is(":visible")&&s.hide_input(),s.$history.is(":visible")&&s.hide_history())}),this.$input.mousedown(function(s){s.stopPropagation()}),this.$history.mousedown(function(s){s.stopPropagation()})}render_message(s){return $(`<div>${s}</div>`)}add_message(s,e){this.show_history();let t=`${s}: ${e}`;this.$history.append(this.render_message(t)),this.$history.scrollTop(this.$history[0].scrollHeight)}show_history(){let s=this;this.$history.fadeIn(),this.func_id||this.$input.is(":visible")||(this.func_id=setTimeout(function(){s.$history.fadeOut(),s.func_id=null},3e3))}show_input(){this.$input.show(),this.$input.focus(),this.show_history()}hide_input(){this.$input.hide(),this.playground.game_map.$canvas.focus(),this.show_history()}hide_history(){this.$history.hide(),this.func_id&&(clearTimeout(this.func_id),this.func_id=null),this.playground.game_map.$canvas.focus()}}class GameMap extends AcGameObject{constructor(s){super(),this.playground=s,this.$canvas=$("<canvas tabindex=0></canvas>"),this.ctx=this.$canvas[0].getContext("2d"),this.ctx.canvas.width=this.playground.width,this.ctx.canvas.height=this.playground.height,this.playground.$playground.append(this.$canvas)}start(){this.$canvas.focus()}resize(){this.ctx.canvas.width=this.playground.width,this.ctx.canvas.height=this.playground.height,this.ctx.fillStyle="rgba(0, 0, 0, 1)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}update(){this.render()}render(){this.ctx.fillStyle="rgba(0, 0, 0, 0.2)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}}class NoticeBoard extends AcGameObject{constructor(s){super(),this.playground=s,this.ctx=this.playground.game_map.ctx,this.text="已就绪：0人"}start(){}write(s){this.text=s}update(){this.render()}render(){this.ctx.font="20px serif",this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.fillText(this.text,this.playground.width/2,20)}}class Particle extends AcGameObject{constructor(s,e,t,i,a,n,r,o,c){super(),this.playground=s,this.ctx=this.playground.game_map.ctx,this.x=e,this.y=t,this.radius=i,this.vx=a,this.vy=n,this.color=r,this.speed=o,this.friction=.9,this.eps=.01,this.move_length=c}start(){}update(){if(this.move_length<this.eps||this.speed<this.eps)return this.destroy(),!1;let s=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*s,this.y+=this.vy*s,this.speed*=this.friction,this.move_length-=s,this.render()}render(){let s=this.playground.scale;this.ctx.beginPath(),this.ctx.arc(this.x*s,this.y*s,this.radius*s,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()}}class Player extends AcGameObject{constructor(s,e,t,i,a,n,r,o,c){super(),this.playground=s,this.ctx=this.playground.game_map.ctx,this.x=e,this.y=t,this.vx=0,this.vy=0,this.move_length=0,this.radius=i,this.color=a,this.speed=n,this.character=r,this.username=o,this.photo=c,this.eps=.01,this.damage_vx=0,this.damage_vy=0,this.damage_speed=0,this.friction=.9,this.spend_time=0,this.fireballs=[],this.cur_skill=null,"robot"!==this.character&&(this.img=new Image,this.img.src=this.photo),"me"===this.character&&(this.fireball_coldtime=3,this.fireball_img=new Image,this.fireball_img.src="https://cdn.acwing.com/media/article/image/2021/12/02/1_9340c86053-fireball.png",this.blink_coldtime=5,this.blink_img=new Image,this.blink_img.src="https://cdn.acwing.com/media/article/image/2021/12/02/1_daccabdc53-blink.png")}start(){if(this.playground.player_count++,this.playground.notice_board.write("已就绪："+this.playground.player_count+"人"),this.playground.player_count>=3&&(this.playground.state="fighting",this.playground.notice_board.write("Fighting")),"me"===this.character)this.add_listening_events();else if("robot"===this.character){let s=Math.random()*this.playground.width/this.playground.scale,e=Math.random()*this.playground.height/this.playground.scale;this.move_to(s,e)}}add_listening_events(){let s=this;this.playground.game_map.$canvas.on("contextmenu",function(){return!1}),this.playground.game_map.$canvas.mousedown(function(e){if("fighting"!==s.playground.state)return!0;const t=s.ctx.canvas.getBoundingClientRect();if(3===e.which){let i=(e.clientX-t.left)/s.playground.scale,a=(e.clientY-t.top)/s.playground.scale;s.move_to(i,a),"multi mode"===s.playground.mode&&s.playground.mps.send_move_to(i,a)}else if(1===e.which){let i=(e.clientX-t.left)/s.playground.scale,a=(e.clientY-t.top)/s.playground.scale;if("fireball"==s.cur_skill){if(s.fireball_coldtime>s.eps)return!1;let e=s.shoot_fireball(i,a);"multi mode"===s.playground.mode&&s.playground.mps.send_shoot_fireball(i,a,e.uuid)}else if("blink"===s.cur_skill){if(s.blink_coldtime>s.eps)return!1;s.blink(i,a),"multi mode"===s.playground.mode&&s.playground.mps.send_blink(i,a)}s.cur_skill=null}}),this.playground.game_map.$canvas.keydown(function(e){if(13===e.which){if("multi mode"===s.playground.mode)return s.playground.chat_field.show_input(),!1}else if(27===e.which&&"multi mode"===s.playground.mode)return s.playground.chat_field.hide_input(),!1;return"fighting"!==s.playground.state||(81===e.which?s.fireball_coldtime>=s.eps||(s.cur_skill="fireball",!1):70===e.which?s.blink_coldtime>=s.eps||(s.cur_skill="blink",!1):void 0)})}shoot_fireball(s,e){let t=this.x,i=this.y,a=Math.atan2(e-this.y,s-this.x),n=Math.cos(a),r=Math.sin(a),o=new FireBall(this.playground,this,t,i,.01,n,r,"orange",.5,1,.01);return this.fireballs.push(o),this.fireball_coldtime=3,o}blink(s,e){let t=this.get_dist(this.x,this.y,s,e);t=Math.min(t,.8);let i=Math.atan2(e-this.y,s-this.x);this.x+=t*Math.cos(i),this.y+=t*Math.sin(i),this.move_length=0,this.blink_coldtime=5}destroy_fireball(s){for(let e=0;e<this.fireballs.length;e++){let t=this.fireballs[e];if(t.uuid===s){t.destroy();break}}}get_dist(s,e,t,i){let a=s-t,n=e-i;return Math.sqrt(a*a+n*n)}move_to(s,e){this.move_length=this.get_dist(this.x,this.y,s,e);let t=Math.atan2(e-this.y,s-this.x);this.vx=Math.cos(t),this.vy=Math.sin(t)}is_attack(s,e){for(let s=0;s<10+5*Math.random();s++){let s=this.x,e=this.y,t=this.radius*Math.random()*.1,i=2*Math.PI*Math.random(),a=Math.cos(i),n=Math.sin(i),r=this.color,o=10*this.speed,c=this.radius*Math.random()*5;new Particle(this.playground,s,e,t,a,n,r,o,c)}if(this.radius-=e,this.radius<this.eps)return this.destroy(),!1;this.damage_vx=Math.cos(s),this.damage_vy=Math.sin(s),this.damage_speed=100*e,this.speed*=.8}receive_attack(s,e,t,i,a,n){n.destroy_fireball(a),this.x=s,this.y=e,this.is_attack(t,i)}update(){this.spend_time+=this.timedelta/1e3,this.update_win(),"me"===this.character&&"fighting"===this.playground.state&&this.update_coldtime(),this.update_move(),this.render()}update_win(){"fighting"===this.playground.state&&"me"===this.character&&1===this.playground.players.length&&(this.playground.state="over",this.playground.score_board.win())}update_coldtime(){this.fireball_coldtime-=this.timedelta/1e3,this.fireball_coldtime=Math.max(this.fireball_coldtime,0),this.blink_coldtime-=this.timedelta/1e3,this.blink_coldtime=Math.max(this.blink_coldtime,0)}update_move(){if("robot"===this.character&&this.spend_time>5&&Math.random()<1/360){let s=this.playground.players[Math.floor(Math.random()*this.playground.players.length)],e=s.x+s.speed*s.vx*this.timedelta/1e3*.3,t=s.y+s.speed*s.vy*this.timedelta/1e3*.3;this.shoot_fireball(e,t)}if(this.damage_speed>this.eps)this.vx=this.vy=0,this.move_length=0,this.x+=this.damage_vx*this.damage_speed*this.timedelta/1e3,this.y+=this.damage_vy*this.damage_speed*this.timedelta/1e3,this.damage_speed*=this.friction;else if(this.move_length<this.eps){if(this.move_length=0,this.vx=this.vy=0,"robot"===this.character){let s=Math.random()*this.playground.width/this.playground.scale,e=Math.random()*this.playground.height/this.playground.scale;this.move_to(s,e)}}else{let s=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*s,this.y+=this.vy*s,this.move_length-=s}}render(){let s=this.playground.scale;"robot"!==this.character?(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(this.x*s,this.y*s,this.radius*s,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.8)",this.ctx.lineWidth=3,this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.img,(this.x-this.radius)*s,(this.y-this.radius)*s,2*this.radius*s,2*this.radius*s),this.ctx.restore()):(this.ctx.beginPath(),this.ctx.arc(this.x*s,this.y*s,this.radius*s,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()),"me"===this.character&&"fighting"===this.playground.state&&this.render_skill_coldtime()}render_skill_coldtime(){let s=this.playground.scale,e=1.5,t=.9,i=.04;this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(e*s,t*s,i*s,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.fireball_img,(e-i)*s,(t-i)*s,2*i*s,2*i*s),this.ctx.restore(),this.fireball_coldtime>=this.eps&&(this.ctx.beginPath(),this.ctx.moveTo(e*s,t*s),this.ctx.arc(e*s,t*s,i*s,0-Math.PI/2,2*Math.PI*(1-this.fireball_coldtime/3)-Math.PI/2,!0),this.ctx.lineTo(e*s,t*s),this.ctx.fillStyle="rgba(0, 0, 255, 0.6)",this.ctx.fill()),e=1.62,t=.9,i=.04,this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(e*s,t*s,i*s,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.blink_img,(e-i)*s,(t-i)*s,2*i*s,2*i*s),this.ctx.restore(),this.blink_coldtime>=this.eps&&(this.ctx.beginPath(),this.ctx.moveTo(e*s,t*s),this.ctx.arc(e*s,t*s,i*s,0-Math.PI/2,2*Math.PI*(1-this.blink_coldtime/5)-Math.PI/2,!0),this.ctx.lineTo(e*s,t*s),this.ctx.fillStyle="rgba(0, 0, 255, 0.6)",this.ctx.fill())}on_destroy(){"me"==this.character&&"fighting"===this.playground.state&&(this.playground.state="over",this.playground.score_board.lose());for(let s=0;s<this.playground.players.length;s++)if(this.playground.players[s]===this){this.playground.players.splice(s,1);break}}}class ScoreBoard extends AcGameObject{constructor(s){super(),this.playground=s,this.ctx=this.playground.game_map.ctx,this.state=null,this.win_img=new Image,this.win_img.src="https://cdn.acwing.com/media/article/image/2021/12/17/1_8f58341a5e-win.png",this.lose_img=new Image,this.lose_img.src="https://cdn.acwing.com/media/article/image/2021/12/17/1_9254b5f95e-lose.png"}start(){}add_listening_events(){let s=this;this.playground.game_map.$canvas.on("click",function(){s.playground.hide(),s.playground.root.menu.show()})}win(){this.state="win";let s=this;setTimeout(function(){s.add_listening_events()},1e3)}lose(){this.state="lose";let s=this;setTimeout(function(){s.add_listening_events()},1e3)}late_update(){this.render()}render(){let s=this.playground.height/2;"win"===this.state?this.ctx.drawImage(this.win_img,this.playground.width/2-s/2,this.playground.height/2-s/2,s,s):"lose"===this.state&&this.ctx.drawImage(this.lose_img,this.playground.width/2-s/2,this.playground.height/2-s/2,s,s)}}class FireBall extends AcGameObject{constructor(s,e,t,i,a,n,r,o,c,h,l){super(),this.playground=s,this.ctx=this.playground.game_map.ctx,this.player=e,this.x=t,this.y=i,this.vx=n,this.vy=r,this.radius=a,this.color=o,this.speed=c,this.move_length=h,this.damage=l,this.eps=.01}start(){}update(){if(this.move_length<this.eps)return this.destroy(),!1;this.update_move(),"enemy"!==this.player.character&&this.update_attack(),this.render()}update_move(){let s=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*s,this.y+=this.vy*s,this.move_length-=s}update_attack(){for(let s=0;s<this.playground.players.length;s++){let e=this.playground.players[s];if(this.player!==e&&this.is_collision(e)){this.attack(e);break}}}get_dist(s,e,t,i){let a=s-t,n=e-i;return Math.sqrt(a*a+n*n)}is_collision(s){return this.get_dist(this.x,this.y,s.x,s.y)<this.radius+s.radius}attack(s){let e=Math.atan2(s.y-this.y,s.x-this.x);s.is_attack(e,this.damage),"multi mode"===this.playground.mode&&this.playground.mps.send_attack(s.uuid,s.x,s.y,e,this.damage,this.uuid),this.destroy()}render(){let s=this.playground.scale;this.ctx.beginPath(),this.ctx.arc(this.x*s,this.y*s,this.radius*s,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()}on_destroy(){let s=this.player.fireballs;for(let e=0;e<s.length;e++)if(s[e]===this){s.splice(e,1);break}}}class MultiPlayerSocket{constructor(s){this.playground=s,this.ws=new WebSocket("wss://app7562.acapp.acwing.com.cn/wss/multiplayer/"),this.start()}start(){this.receive()}receive(){let s=this;this.ws.onmessage=function(e){let t=JSON.parse(e.data),i=t.uuid;if(i===s.uuid)return!1;let a=t.event;"create_player"===a?s.receive_create_player(i,t.username,t.photo):"move_to"===a?s.receive_move_to(i,t.tx,t.ty):"shoot_fireball"===a?s.receive_shoot_fireball(i,t.tx,t.ty,t.ball_uuid):"attack"===a?s.receive_attack(i,t.attackee_uuid,t.x,t.y,t.angle,t.damage,t.ball_uuid):"blink"==a?s.receive_blink(i,t.tx,t.ty):"message"==a&&s.receive_message(i,t.username,t.text)}}send_create_player(s,e){this.ws.send(JSON.stringify({event:"create_player",uuid:this.uuid,username:s,photo:e}))}receive_create_player(s,e,t){let i=new Player(this.playground,this.playground.width/2/this.playground.scale,.5,.05,"white",.15,"enemy",e,t);i.uuid=s,this.playground.players.push(i)}get_player(s){let e=this.playground.players;for(let t=0;t<e.length;t++){let i=e[t];if(i.uuid===s)return i}return null}send_move_to(s,e){this.ws.send(JSON.stringify({event:"move_to",uuid:this.uuid,tx:s,ty:e}))}receive_move_to(s,e,t){let i=this.get_player(s);i&&i.move_to(e,t)}send_shoot_fireball(s,e,t){this.ws.send(JSON.stringify({event:"shoot_fireball",uuid:this.uuid,tx:s,ty:e,ball_uuid:t}))}receive_shoot_fireball(s,e,t,i){let a=this.get_player(s);if(a){a.shoot_fireball(e,t).uuid=i}}send_attack(s,e,t,i,a,n){this.ws.send(JSON.stringify({event:"attack",uuid:this.uuid,attackee_uuid:s,x:e,y:t,angle:i,damage:a,ball_uuid:n}))}receive_attack(s,e,t,i,a,n,r){let o=this.get_player(s),c=this.get_player(e);o&&c&&c.receive_attack(t,i,a,n,r,o)}send_blink(s,e){this.ws.send(JSON.stringify({event:"blink",uuid:this.uuid,tx:s,ty:e}))}receive_blink(s,e,t){let i=this.get_player(s);i&&i.blink(e,t)}send_message(s,e){this.ws.send(JSON.stringify({event:"message",uuid:this.uuid,username:s,text:e}))}receive_message(s,e,t){this.playground.chat_field.add_message(e,t)}}class AcGamePlayground{constructor(s){this.root=s,this.$playground=$('<div class="ac-game-playground"></div>'),this.hide(),this.root.$ac_game.append(this.$playground),this.start()}get_random_color(){return["blue","red","pink","grey","green"][Math.floor(5*Math.random())]}create_uuid(){let s="";for(let e=0;e<8;e++){s+=parseInt(Math.floor(10*Math.random()))}return s}start(){let s=this,e=this.create_uuid();$(window).on(`resize.${e}`,function(){s.resize()}),this.root.AcWingOS&&s.root.AcWingOS.api.window.on_close(function(){$(window).off(`resize.${e}`)})}resize(){this.width=this.$playground.width(),this.height=this.$playground.height();let s=Math.min(this.width/16,this.height/9);this.width=16*s,this.height=9*s,this.scale=this.height,this.game_map&&this.game_map.resize()}show(s){let e=this;if(this.$playground.show(),this.width=this.$playground.width(),this.height=this.$playground.height(),this.game_map=new GameMap(this),this.mode=s,this.state="waiting",this.notice_board=new NoticeBoard(this),this.score_board=new ScoreBoard(this),this.player_count=0,this.resize(),this.players=[],this.players.push(new Player(this,this.width/2/this.scale,.5,.05,"white",.15,"me",this.root.settings.username,this.root.settings.photo)),"single mode"===s)for(let s=0;s<5;s++)this.players.push(new Player(this,this.width/2/this.scale,.5,.05,this.get_random_color(),.15,"robot"));else"multi mode"===s&&(this.chat_field=new ChatField(this),this.mps=new MultiPlayerSocket(this),this.mps.uuid=this.players[0].uuid,this.mps.ws.onopen=function(){e.mps.send_create_player(e.root.settings.username,e.root.settings.photo)})}hide(){for(;this.players&&this.players.length>0;)this.players[0].destroy();this.game_map&&this.game_map.destroy(),this.notice_board&&(this.notice_board.destroy(),this.notice_board=null),this.score_board&&(this.score_board.destroy(),this.score_board=null),this.$playground.empty(),this.$playground.hide()}}class AcGameUserSettings{constructor(s){this.root=s,this.username_check_timer=null,this.$settings=$('\n            <div class="ac-game-user-settings" style="display: none;">\n                <div class="ac-game-user-settings-container">\n                    <div class="ac-game-user-settings-header">\n                        <h2 class="ac-game-user-settings-title">用户设置</h2>\n                        <button class="ac-game-user-settings-close">×</button>\n                    </div>\n                    <div class="ac-game-user-settings-content">\n                        \x3c!-- 头像设置 --\x3e\n                        <div class="ac-game-user-settings-section">\n                            <h3 class="ac-game-user-settings-section-title">头像设置</h3>\n                            <div class="ac-game-user-settings-avatar-section">\n                                <div class="ac-game-user-settings-avatar-preview">\n                                    <img class="ac-game-user-settings-avatar-img" src="" alt="头像">\n                                </div>\n                                <div class="ac-game-user-settings-avatar-upload">\n                                    <label class="ac-game-user-settings-upload-btn">\n                                        选择图片\n                                        <input type="file" class="ac-game-user-settings-upload-input" accept="image/*">\n                                    </label>\n                                    <div class="ac-game-user-settings-upload-info">\n                                        支持 JPG、PNG、GIF 格式，大小不超过 2MB\n                                    </div>\n                                    <div class="ac-game-user-settings-avatar-message"></div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- 基本信息 --\x3e\n                        <div class="ac-game-user-settings-section">\n                            <h3 class="ac-game-user-settings-section-title">\n                                基本信息\n                                <span class="ac-game-user-settings-auth-badge"></span>\n                            </h3>\n                            <div class="ac-game-user-settings-form-group">\n                                <label class="ac-game-user-settings-label">用户名</label>\n                                <div class="ac-game-user-settings-input-wrapper">\n                                    <input type="text" class="ac-game-user-settings-input ac-game-user-settings-username" placeholder="输入新用户名">\n                                    <span class="ac-game-user-settings-username-status"></span>\n                                </div>\n                                <div class="ac-game-user-settings-username-message"></div>\n                            </div>\n                            <button class="ac-game-user-settings-btn ac-game-user-settings-username-btn">\n                                更新用户名\n                            </button>\n                        </div>\n\n                        \x3c!-- 密码修改（仅本地用户显示） --\x3e\n                        <div class="ac-game-user-settings-section ac-game-user-settings-password-section" style="display: none;">\n                            <h3 class="ac-game-user-settings-section-title">修改密码</h3>\n                            <div class="ac-game-user-settings-form-group">\n                                <label class="ac-game-user-settings-label">当前密码</label>\n                                <input type="password" class="ac-game-user-settings-input ac-game-user-settings-old-password" placeholder="输入当前密码">\n                            </div>\n                            <div class="ac-game-user-settings-form-group">\n                                <label class="ac-game-user-settings-label">新密码</label>\n                                <input type="password" class="ac-game-user-settings-input ac-game-user-settings-new-password" placeholder="输入新密码（至少6位）">\n                            </div>\n                            <div class="ac-game-user-settings-form-group">\n                                <label class="ac-game-user-settings-label">确认新密码</label>\n                                <input type="password" class="ac-game-user-settings-input ac-game-user-settings-confirm-password" placeholder="再次输入新密码">\n                            </div>\n                            <div class="ac-game-user-settings-password-message"></div>\n                            <button class="ac-game-user-settings-btn ac-game-user-settings-password-btn">\n                                更新密码\n                            </button>\n                        </div>\n\n                        \x3c!-- 账号信息 --\x3e\n                        <div class="ac-game-user-settings-section">\n                            <h3 class="ac-game-user-settings-section-title">账号信息</h3>\n                            <div class="ac-game-user-settings-form-group">\n                                <label class="ac-game-user-settings-label">得分</label>\n                                <input type="text" class="ac-game-user-settings-input ac-game-user-settings-score" disabled>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        '),this.$settings.hide(),this.root.$ac_game.append(this.$settings),this.$close_btn=this.$settings.find(".ac-game-user-settings-close"),this.$avatar_img=this.$settings.find(".ac-game-user-settings-avatar-img"),this.$avatar_input=this.$settings.find(".ac-game-user-settings-upload-input"),this.$avatar_message=this.$settings.find(".ac-game-user-settings-avatar-message"),this.$username_input=this.$settings.find(".ac-game-user-settings-username"),this.$username_status=this.$settings.find(".ac-game-user-settings-username-status"),this.$username_message=this.$settings.find(".ac-game-user-settings-username-message"),this.$username_btn=this.$settings.find(".ac-game-user-settings-username-btn"),this.$password_section=this.$settings.find(".ac-game-user-settings-password-section"),this.$old_password=this.$settings.find(".ac-game-user-settings-old-password"),this.$new_password=this.$settings.find(".ac-game-user-settings-new-password"),this.$confirm_password=this.$settings.find(".ac-game-user-settings-confirm-password"),this.$password_message=this.$settings.find(".ac-game-user-settings-password-message"),this.$password_btn=this.$settings.find(".ac-game-user-settings-password-btn"),this.$auth_badge=this.$settings.find(".ac-game-user-settings-auth-badge"),this.$score_input=this.$settings.find(".ac-game-user-settings-score"),this.start()}start(){this.add_listening_events()}add_listening_events(){let s=this;this.$close_btn.click(function(){s.hide(),s.root.menu.show()}),$(window).keydown(function(e){27===e.which&&s.$settings.is(":visible")&&(s.hide(),s.root.menu.show())}),this.$avatar_input.change(function(){s.upload_avatar(this.files[0])}),this.$username_input.on("input",function(){s.check_username()}),this.$username_btn.click(function(){s.update_username()}),this.$password_btn.click(function(){s.update_password()})}show(){this.$settings.show(),this.load_user_settings()}hide(){this.$settings.hide(),this.clear_messages()}clear_messages(){this.$avatar_message.empty(),this.$username_message.empty(),this.$password_message.empty(),this.$username_status.empty(),this.$old_password.val(""),this.$new_password.val(""),this.$confirm_password.val("")}load_user_settings(){let s=this;$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/get_user_settings/",type:"GET",success:function(e){if("success"===e.result){s.$avatar_img.attr("src",e.photo),s.$username_input.val(e.username),s.$score_input.val(e.score);let t="",i="";"github"===e.auth_type?(t="GitHub",i="github"):"gitee"===e.auth_type?(t="Gitee",i="gitee"):"acwing"===e.auth_type?(t="AcWing",i="acwing"):(t="本地账号",i="local"),s.$auth_badge.text(t).attr("class","ac-game-user-settings-auth-badge "+i),e.can_change_password?s.$password_section.show():s.$password_section.hide()}},error:function(){s.$username_message.html('<div class="ac-game-user-settings-error">加载用户信息失败</div>')}})}check_username(){let s=this,e=this.$username_input.val().trim();this.username_check_timer&&clearTimeout(this.username_check_timer),this.$username_status.empty(),this.$username_message.empty(),e&&(this.$username_status.html("⏳").attr("class","ac-game-user-settings-username-status checking"),this.username_check_timer=setTimeout(function(){$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/check_username/",type:"GET",data:{username:e},success:function(e){e.available?(s.$username_status.html("✓").attr("class","ac-game-user-settings-username-status available"),"当前用户名"!==e.message&&s.$username_message.html('<div class="ac-game-user-settings-success">'+e.message+"</div>")):(s.$username_status.html("✗").attr("class","ac-game-user-settings-username-status unavailable"),s.$username_message.html('<div class="ac-game-user-settings-error">'+e.message+"</div>"))}})},500))}update_username(){let s=this,e=this.$username_input.val().trim();e?(this.$username_btn.prop("disabled",!0),$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/update_username/",type:"POST",headers:{"X-CSRFToken":this.get_csrf_token()},data:JSON.stringify({username:e}),contentType:"application/json",success:function(e){"success"===e.result?(s.$username_message.html('<div class="ac-game-user-settings-success">'+e.message+"</div>"),s.root.settings.username=e.username):s.$username_message.html('<div class="ac-game-user-settings-error">'+e.message+"</div>")},error:function(){s.$username_message.html('<div class="ac-game-user-settings-error">更新失败，请重试</div>')},complete:function(){s.$username_btn.prop("disabled",!1)}})):this.$username_message.html('<div class="ac-game-user-settings-error">请输入用户名</div>')}update_password(){let s=this,e=this.$old_password.val(),t=this.$new_password.val(),i=this.$confirm_password.val();this.$password_message.empty(),e&&t&&i?t===i?t.length<6?this.$password_message.html('<div class="ac-game-user-settings-error">密码长度至少为6个字符</div>'):(this.$password_btn.prop("disabled",!0),$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/update_password/",type:"POST",headers:{"X-CSRFToken":this.get_csrf_token()},data:JSON.stringify({old_password:e,new_password:t,confirm_password:i}),contentType:"application/json",success:function(e){"success"===e.result?(s.$password_message.html('<div class="ac-game-user-settings-success">'+e.message+"</div>"),s.$old_password.val(""),s.$new_password.val(""),s.$confirm_password.val("")):s.$password_message.html('<div class="ac-game-user-settings-error">'+e.message+"</div>")},error:function(){s.$password_message.html('<div class="ac-game-user-settings-error">更新失败，请重试</div>')},complete:function(){s.$password_btn.prop("disabled",!1)}})):this.$password_message.html('<div class="ac-game-user-settings-error">两次输入的新密码不一致</div>'):this.$password_message.html('<div class="ac-game-user-settings-error">请填写所有密码字段</div>')}upload_avatar(s){let e=this;if(!s)return;if(s.size>2097152)return void this.$avatar_message.html('<div class="ac-game-user-settings-error">图片大小不能超过2MB</div>');if(!["image/jpeg","image/png","image/gif"].includes(s.type))return void this.$avatar_message.html('<div class="ac-game-user-settings-error">只支持 JPG、PNG、GIF 格式</div>');let t=new FormData;t.append("avatar",s),this.$avatar_message.html('<div class="ac-game-user-settings-hint">上传中...</div>'),$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/upload_avatar/",type:"POST",headers:{"X-CSRFToken":this.get_csrf_token()},data:t,processData:!1,contentType:!1,success:function(s){"success"===s.result?(e.$avatar_message.html('<div class="ac-game-user-settings-success">'+s.message+"</div>"),e.$avatar_img.attr("src",s.photo),e.root.settings.photo=s.photo):e.$avatar_message.html('<div class="ac-game-user-settings-error">'+s.message+"</div>")},error:function(){e.$avatar_message.html('<div class="ac-game-user-settings-error">上传失败，请重试</div>')}})}get_csrf_token(){let s=null,e="csrftoken";if(document.cookie&&""!==document.cookie){let t=document.cookie.split(";");for(let i=0;i<t.length;i++){let a=t[i].trim();if(a.substring(0,10)===e+"="){s=decodeURIComponent(a.substring(10));break}}}return s}}class Settings{constructor(s){this.root=s,this.platform="WEB",this.root.AcWingOS&&(this.platform="ACAPP"),this.username="",this.photo="",this.$settings=$('\n<div class="ac-game-settings">\n    <div class="ac-game-settings-login">\n        <div class="ac-game-settings-title">\n            登录\n        </div>\n        <div class="ac-game-settings-username">\n            <div class="ac-game-settings-item">\n                <input type="text" placeholder="用户名">\n            </div>\n        </div>\n        <div class="ac-game-settings-password">\n            <div class="ac-game-settings-item">\n                <input type="password" placeholder="密码">\n            </div>\n        </div>\n        <div class="ac-game-settings-submit">\n            <div class="ac-game-settings-item">\n                <button>登录</button>\n            </div>\n        </div>\n        <div class="ac-game-settings-error-message">\n        </div>\n        <div class="ac-game-settings-option">\n            注册\n        </div>\n        <br>\n        <div class="ac-game-settings-acwing">\n            <img width="30" src="https://app7562.acapp.acwing.com.cn/static/image/login/acwing.png"  alt="AcWing Login">\n        </div>\n        <div class="ac-game-settings-github">\n            <img src="https://app7562.acapp.acwing.com.cn/static/image/login/github.png" alt="GitHub Login">\n        </div>\n            <div class="ac-game-settings-gitee">\n            <img src="https://app7562.acapp.acwing.com.cn/static/image/login/gitee.png" alt="Gitee Login">\n        </div>\n    </div>\n    <div class="ac-game-settings-register">\n        <div class="ac-game-settings-title">\n            注册\n        </div>\n        <div class="ac-game-settings-username">\n            <div class="ac-game-settings-item">\n                <input type="text" placeholder="用户名">\n            </div>\n        </div>\n        <div class="ac-game-settings-password ac-game-settings-password-first">\n            <div class="ac-game-settings-item">\n                <input type="password" placeholder="密码">\n            </div>\n        </div>\n        <div class="ac-game-settings-password ac-game-settings-password-second">\n            <div class="ac-game-settings-item">\n                <input type="password" placeholder="确认密码">\n            </div>\n        </div>\n        <div class="ac-game-settings-submit">\n            <div class="ac-game-settings-item">\n                <button>注册</button>\n            </div>\n        </div>\n        <div class="ac-game-settings-error-message">\n        </div>\n        <div class="ac-game-settings-option">\n            登录\n        </div>\n        <br>\n        <div class="ac-game-settings-acwing" title="AcWing 一键登录">\n            <img width="30" src="https://app7562.acapp.acwing.com.cn/static/image/login/acwing.png"  alt="AcWing Login">\n        </div>\n        <div class="ac-game-settings-github" title="GitHub 一键登录">\n            <img src="https://app7562.acapp.acwing.com.cn/static/image/login/github.png" alt="GitHub Login">\n        </div>\n            <div class="ac-game-settings-gitee" title="Gitee 一键登录">\n            <img src="https://app7562.acapp.acwing.com.cn/static/image/login/gitee.png" alt="Gitee Login">\n        </div>\n    </div>\n'),this.$login=this.$settings.find(".ac-game-settings-login"),this.$login_username=this.$login.find(".ac-game-settings-username input"),this.$login_password=this.$login.find(".ac-game-settings-password input"),this.$login_submit=this.$login.find(".ac-game-settings-submit button"),this.$login_error_message=this.$login.find(".ac-game-settings-error-message"),this.$login_register=this.$login.find(".ac-game-settings-option"),this.$login.hide(),this.$register=this.$settings.find(".ac-game-settings-register"),this.$register_username=this.$register.find(".ac-game-settings-username input"),this.$register_password=this.$register.find(".ac-game-settings-password-first input"),this.$register_password_confirm=this.$register.find(".ac-game-settings-password-second input"),this.$register_submit=this.$register.find(".ac-game-settings-submit button"),this.$register_error_message=this.$register.find(".ac-game-settings-error-message"),this.$register_login=this.$register.find(".ac-game-settings-option"),this.$register.hide(),this.$acwing_login=this.$settings.find(".ac-game-settings-acwing img"),this.$github_login=this.$settings.find(".ac-game-settings-github img"),this.$gitee_login=this.$settings.find(".ac-game-settings-gitee img"),this.add_listening_events(),this.root.$ac_game.append(this.$settings),this.start()}start(){"ACAPP"===this.platform?this.getinfo_acapp():(this.getinfo_web(),this.add_listening_events())}add_listening_events(){let s=this;this.add_listening_events_login(),this.add_listening_events_register(),this.$acwing_login.click(function(){s.acwing_login()}),this.$github_login.click(function(){s.github_login()}),this.$gitee_login.click(function(){s.gitee_login()})}acwing_login(){$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/acwing/web/apply_code/",type:"GET",success:function(s){"success"===s.result&&window.location.replace(s.apply_code_url)}})}github_login(){$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/github/web/apply_code/",type:"GET",success:function(s){"success"===s.result&&window.location.replace(s.apply_code_url)},error:function(s,e,t){console.error("GitHub 登录失败:",t),alert("GitHub 登录暂时不可用，请稍后重试")}})}gitee_login(){$.ajax({url:"/settings/gitee/web/apply_code/",type:"GET",success:function(s){"success"===s.result&&window.location.replace(s.apply_code_url)},error:function(s,e,t){console.error("Gitee 登录失败:",t),alert("Gitee 登录暂时不可用，请稍后重试")}})}add_listening_events_login(){let s=this;this.$login_register.click(function(){s.register()}),this.$login_submit.click(function(){s.login_on_remote()}),this.$login_username.keydown(function(e){13===e.which&&s.login_on_remote()}),this.$login_password.keydown(function(e){13===e.which&&s.login_on_remote()})}add_listening_events_register(){let s=this;this.$register_login.click(function(){s.login()}),this.$register_submit.click(function(){s.register_on_remote()}),this.$register_username.keydown(function(e){13===e.which&&s.register_on_remote()}),this.$register_password.keydown(function(e){13===e.which&&s.register_on_remote()}),this.$register_password_confirm.keydown(function(e){13===e.which&&s.register_on_remote()})}login_on_remote(){let s=this,e=this.$login_username.val(),t=this.$login_password.val();this.$login_error_message.empty(),$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/login/",type:"GET",data:{username:e,password:t},success:function(e){"success"===e.result?location.reload():s.$login_error_message.html(e.result)}})}register_on_remote(){let s=this,e=this.$register_username.val(),t=this.$register_password.val(),i=this.$register_password_confirm.val();this.$register_error_message.empty(),$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/register/",type:"GET",data:{username:e,password:t,password_confirm:i},success:function(e){"success"===e.result?location.reload():s.$register_error_message.html(e.result)}})}logout_on_remote(){"ACAPP"===this.platform&&this.root.AcWingOS.api.window.close(),$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/logout/",type:"GET",success:function(s){"success"===s.result&&location.reload()}})}register(){this.$login.hide(),this.$register.show()}acapp_login(s,e,t,i){let a=this;this.root.AcWingOS.api.oauth2.authorize(s,e,t,i,function(s){"success"===s.result&&(a.username=s.username,a.photo=s.photo,a.hide(),a.root.menu.show())})}login(){this.$login.show(),this.$register.hide()}getinfo_acapp(){let s=this;$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/acwing/acapp/apply_code/",type:"GET",success:function(e){"success"===e.result&&s.acapp_login(e.appid,e.redirect_uri,e.scope,e.state)}})}getinfo_web(){let s=this;$.ajax({url:"https://app7562.acapp.acwing.com.cn/settings/getinfo/",type:"GET",data:{platform:s.platform},success:function(e){"success"===e.result?(s.username=e.username,s.photo=e.photo,s.hide(),s.root.menu.show()):s.login()}})}hide(){this.$settings.hide()}show(){this.$settings.show()}}export class AcGame{constructor(s,e){this.id=s,this.$ac_game=$("#"+s),this.AcWingOS=e,this.settings=new Settings(this),this.menu=new AcGameMenu(this),this.playground=new AcGamePlayground(this),this.chatroom=new AcGameChatRoom(this),this.leaderboard=new AcGameLeaderboard(this),this.user_settings=new AcGameUserSettings(this),this.start()}start(){}}
